<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        /* Estilos Gerais */
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #fff;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Dashboard */
        #dashboard {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            padding: 20px;
            width: 100%;
            max-width: 800px;
            margin: auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px;
        }

        /* Imagem de Perfil */
        .profile-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #333;
            cursor: pointer;
            overflow: hidden;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }

        .profile-image:hover {
            border-color: #4CAF50;
        }

        .profile-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Conteúdo Principal */
        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }

        /* Painel de Configurações */
        #settingsPanel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }

        .settings-content {
            background-color: #212121;
            padding: 20px;
            border-radius: 8px;
            text-align: left;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-content h2 {
            color: #fff;
            margin-bottom: 20px;
            text-align: center;
        }

        .settings-content label {
            display: block;
            margin-bottom: 5px;
            color: #ddd;
        }

        .settings-content input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #333;
            color: #fff;
            box-sizing: border-box;
        }

        #profileImageInput {
            display: none;
        }

        .settings-content button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }

        .settings-content button:hover {
            background-color: #3e8e41;
        }

        .settings-content .profile-image {
            margin: 20px auto;
            display: block;
            width: 100px;
            height: 100px;
        }

        .settings-content .profile-image:hover {
            border-color: #4CAF50;
        }

        /* Esconde o input padrão de arquivo */
        .custom-file-upload {
            border: 1px solid #ccc;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            background-color: #333;
            color: #fff;
            margin-bottom: 15px;
        }

        /* Estilos para o painel de sucesso */
        #successPanel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #successPanel .content {
            background-color: #212121;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #successPanel h2 {
            color: #fff;
            margin-bottom: 10px;
        }

        #successPanel p {
            color: #ddd;
            font-size: 18px;
        }

        /* Estilos para o painel de seleção de conta */
        #accountSelectionPanel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            /* Adiciona barra de rolagem se necessário */
        }

        #accountSelectionPanel .content {
            background-color: #212121;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            max-width: 80%;
            /* Limita a largura do conteúdo */
            max-height: 80%;
            /* Limita a altura do conteúdo */
        }

        #accountSelectionPanel h2 {
            color: #fff;
            margin-bottom: 10px;
        }

        #accountSelectionPanel ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #accountSelectionPanel li {
            margin-bottom: 10px;
        }

        #accountSelectionPanel button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        #accountSelectionPanel button:hover {
            background-color: #3e8e41;
        }

        /* Formulário de Registro */
        .container {
            background-color: #212121;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            padding: 30px;
            width: 400px;
            text-align: center;
        }

        h1 {
            color: #fff;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ddd;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 8px;
            font-size: 16px;
            background-color: #333;
            color: #fff;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #3e8e41;
        }

        .password-strength {
            font-size: 12px;
            margin-top: 5px;
            color: #888;
        }

        .password-strength.weak {
            color: red;
        }

        .password-strength.medium {
            color: orange;
        }

        .password-strength.strong {
            color: green;
        }
    </style>
</head>

<body>

    <!-- Formulário de Registro/Login -->
    <div class="container" id="registrationForm">
        <h1>Criar/Login Usuário</h1>
        <form id="createUserForm">
            <div class="form-group">
                <label for="name">Nome:</label>
                <input type="text" id="name" name="name" placeholder="Digite seu nome completo" required>
            </div>
            <div class="form-group">
                <label for="nickname">Nickname:</label>
                <input type="text" id="nickname" name="nickname" placeholder="Escolha um nickname" required>
            </div>
            <div class="form-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" name="password" placeholder="Digite sua senha" required>
                <div id="passwordStrength" class="password-strength"></div>
            </div>
            <button type="submit">Criar Conta</button>
            <button type="button" id="loginButton">Login</button>
        </form>
    </div>

    <!-- Painel de Sucesso -->
    <div id="successPanel">
        <div class="content">
            <h2>Usuário Criado com Sucesso!</h2>
            <p>Redirecionando...</p>
        </div>
    </div>

    <!-- Painel de Seleção de Conta -->
    <div id="accountSelectionPanel">
        <div class="content">
            <h2>Selecione sua conta:</h2>
            <ul id="accountList">
                <!-- As contas serão adicionadas aqui dinamicamente -->
            </ul>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
        <div class="dashboard-header">
            <div class="profile-image" id="profileImage">
                <img src="placeholder-image.png" alt="Imagem de Perfil">
            </div>
        </div>
        <div class="main-content">
            Bem-vindo ao seu Painel!
        </div>
    </div>

    <!-- Painel de Configurações -->
    <div id="settingsPanel">
        <div class="settings-content">
            <h2>Configurações</h2>
            <div style="text-align: center;">
                <div class="profile-image">
                    <img src="placeholder-image.png" alt="Imagem de Perfil">
                </div>
                <label for="profileImageInput" class="custom-file-upload">
                    Selecionar Imagem
                </label>
                <input type="file" id="profileImageInput" accept="image/*">
            </div>

            <label for="newNickname">Novo Nickname:</label>
            <input type="text" id="newNickname" placeholder="Novo nickname">

            <button id="saveChanges">Salvar Alterações</button>
        </div>
    </div>

    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import {
            getDatabase,
            ref,
            push,
            set,
            get,
            update
        } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";

        // Configurações do SEU projeto Firebase (SUBSTITUA!)
        const firebaseConfig = {
            apiKey: "AIzaSyBuj2PUWB6YHaE5DPrWnE34NGUGnZDYvDE",
            authDomain: "banco-5a678.firebaseapp.com",
            databaseURL: "https://banco-5a678-default-rtdb.firebaseio.com",
            projectId: "banco-5a678",
            storageBucket: "banco-5a678.firebasestorage.app",
            messagingSenderId: "943801310064",
            appId: "1:943801310064:web:50534c4cdaa459a7b74db5",
            measurementId: "G-DEER2QFNXL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Elementos do DOM
        const passwordInput = document.getElementById('password');
        const passwordStrength = document.getElementById('passwordStrength');
        const successPanel = document.getElementById('successPanel');
        const registrationForm = document.getElementById('registrationForm');
        const dashboard = document.getElementById('dashboard');
        const accountSelectionPanel = document.getElementById('accountSelectionPanel');
        const accountList = document.getElementById('accountList');
        const profileImage = document.getElementById('profileImage');
        const settingsPanel = document.getElementById('settingsPanel');
        const newNicknameInput = document.getElementById('newNickname');
        const saveChangesButton = document.getElementById('saveChanges');
        const profileImageInput = document.getElementById('profileImageInput');
        const dashboardProfileImage = document.querySelector('#dashboard .profile-image img');
        const settingsProfileImage = document.querySelector('#settingsPanel .profile-image img');

        let allUsers = {};
        let loggedInUserId = null; //Armazena o ID do usuário logado
        let currentProfileImageUrl = "placeholder-image.png"; //URL da imagem do perfil

        // Inicializar o perfil com a imagem padrão
        dashboardProfileImage.src = currentProfileImageUrl;
        settingsProfileImage.src = currentProfileImageUrl;


        // Funções auxiliares para LocalStorage
        function setLoggedInUser(userId) {
            localStorage.setItem('loggedInUserId', userId);
        }

        function getLoggedInUser() {
            return localStorage.getItem('loggedInUserId');
        }

        function clearLoggedInUser() {
            localStorage.removeItem('loggedInUserId');
        }

        // FUNÇÕES AUXILIARES
        // Função para atualizar a imagem de perfil (localmente)
        function updateProfileImage(imageUrl) {
            dashboardProfileImage.src = imageUrl;
            settingsProfileImage.src = imageUrl;
        }

        //Listener para atualizar a senha
        passwordInput.addEventListener('input', function() {
            const password = passwordInput.value;
            let strength = '';
            let strengthClass = '';

            if (password.length === 0) {
                strength = '';
                strengthClass = '';
            } else if (password.length < 8) {
                strength = 'Fraca';
                strengthClass = 'weak';
            } else if (password.length < 12) {
                strength = 'Média';
                strengthClass = 'medium';
            } else {
                strength = 'Forte';
                strengthClass = 'strong';
            }

            passwordStrength.textContent = strength ? `Senha: ${strength}` : '';
            passwordStrength.className = `password-strength ${strengthClass}`;
        });

        //Listener para criar a conta
        document.getElementById('createUserForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const name = document.getElementById('name').value;
            const nickname = document.getElementById('nickname').value;
            const password = document.getElementById('password').value;

            const usersRef = ref(db, 'users');
            const newUserRef = push(usersRef);

            set(newUserRef, {
                    name: name,
                    nickname: nickname,
                    password: password, // **NÃO FAZER ISSO EM PRODUÇÃO!!!**
                    profileImage: currentProfileImageUrl // Adiciona a URL da imagem de perfil
                })
                .then(() => {
                    // Mostrar o painel de sucesso
                    registrationForm.style.display = 'none'; //Esconde form
                    successPanel.style.display = 'flex';

                    // Redirecionar para o painel após alguns segundos
                    setTimeout(() => {
                        successPanel.style.display = 'none'; //Esconde o painel de sucesso
                        loadUsersAndShowAccountSelection(); // Carrega usuários e exibe seleção de conta
                    }, 2000); // Redireciona após 2 segundos
                })
                .catch((error) => {
                    console.error("Erro ao salvar usuário:", error);
                    alert('Erro ao criar usuário. Verifique o console.');
                });
        });

        // Listener para carregar imagem
        profileImageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentProfileImageUrl = e.target.result;
                    updateProfileImage(currentProfileImageUrl);
                }
                reader.readAsDataURL(file);
            }
        });

        // Listener para abrir o painel de configurações
        profileImage.addEventListener('click', function() {
            settingsPanel.style.display = 'flex';
            // Desativar o overflow do body ao abrir o painel
            document.body.style.overflow = 'hidden';
        });

        // Listener para salvar as alterações
        saveChangesButton.addEventListener('click', async function() {
            const newNickname = newNicknameInput.value;

            if (loggedInUserId) {
                const userRef = ref(db, 'users/' + loggedInUserId);
                const updates = {};

                if (newNickname) {
                    updates['nickname'] = newNickname;
                }
                updates['profileImage'] = currentProfileImageUrl; // Salva a URL da imagem de perfil

                try {
                    await update(userRef, updates);
                    alert('Perfil atualizado com sucesso!');
                    settingsPanel.style.display = 'none';
                    document.body.style.overflow = 'auto'; // Reativa o overflow

                    // Atualiza a exibição do nome no painel de seleção
                    loadUsersAndShowAccountSelection();

                } catch (error) {
                    console.error("Erro ao atualizar perfil:", error);
                    alert('Erro ao atualizar perfil. Verifique o console.');
                }
            } else {
                alert('Nenhum usuário logado.');
            }
        });

        // FUNÇÕES PARA LOGIN
        // Função para carregar os usuários do Firebase
        async function loadUsersAndShowAccountSelection() {
            const usersRef = ref(db, 'users');
            try {
                const snapshot = await get(usersRef);
                if (snapshot.exists()) {
                    allUsers = snapshot.val(); // Armazena todos os usuários
                    displayAccountSelection(allUsers); // Exibe a lista de contas
                } else {
                    alert("Nenhuma conta encontrada. Crie uma conta primeiro.");
                }
            } catch (error) {
                console.error("Erro ao carregar usuários:", error);
                alert("Erro ao carregar usuários. Verifique o console.");
            }
        }

        // Função para exibir o painel de seleção de conta
        function displayAccountSelection(users) {
            accountList.innerHTML = ''; // Limpa a lista existente

            for (const userId in users) {
                const user = users[userId];
                const listItem = document.createElement('li');
                const button = document.createElement('button');
                button.textContent = user.name; // Mostra o nome do usuário no botão
                button.addEventListener('click', () => {
                    login(userId); // Chama a função de login com o ID do usuário
                });
                listItem.appendChild(button);
                accountList.appendChild(listItem);
            }

            registrationForm.style.display = 'none'; // Esconde o formulário de registro
            accountSelectionPanel.style.display = 'flex'; // Mostra o painel de seleção
            document.body.style.justifyContent = 'center';
            document.body.style.alignItems = 'center';
        }

        // Função de login
        function login(userId) {
            accountSelectionPanel.style.display = 'none'; // Esconde a seleção de conta
            registrationForm.style.display = 'none'; // Esconde o form
            dashboard.style.display = 'flex'; // Mostra o dashboard (usar flex para o header)
            document.body.style.justifyContent = 'flex-start'; // Alinha ao topo
            document.body.style.alignItems = 'flex-start';
            loggedInUserId = userId; // Define o ID do usuário logado
            setLoggedInUser(userId);

            // Atualiza a imagem de perfil no dashboard ao fazer login
            const userProfileImage = allUsers[userId].profileImage || "placeholder-image.png"; // Se não houver imagem, usa a padrão
            updateProfileImage(userProfileImage);

            currentProfileImageUrl = userProfileImage; //Mantem atualizada a URL da imagem
        }

        // Evento do botão de login
        document.getElementById('loginButton').addEventListener('click', function(event) {
            event.preventDefault();
            loadUsersAndShowAccountSelection();
        });

        document.addEventListener('click', function(event) {
            const target = event.target;
            if (target == settingsPanel) {
                settingsPanel.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        // Verificar se há um usuário logado ao carregar a página
        window.addEventListener('load', function() {
            const storedUserId = getLoggedInUser();
            if (storedUserId) {
                loggedInUserId = storedUserId; // Define o ID do usuário logado
                // Agora precisamos carregar os usuários para poder mostrar o dashboard corretamente
                loadUsersAndShowDashboard(storedUserId);
            } else {
                // Se não houver usuário logado, mostrar a tela de login/cadastro
                registrationForm.style.display = 'block';
            }
        });

        // Funções auxiliares para carregar os usuários e mostrar o dashboard
        async function loadUsersAndShowDashboard(userId) {
            const usersRef = ref(db, 'users');
            try {
                const snapshot = await get(usersRef);
                if (snapshot.exists()) {
                    allUsers = snapshot.val(); // Armazena todos os usuários
                    login(userId); // Chama a função login com o ID do usuário
                } else {
                    alert("Nenhuma conta encontrada. Crie uma conta primeiro.");
                }
            } catch (error) {
                console.error("Erro ao carregar usuários:", error);
                alert("Erro ao carregar usuários. Verifique o console.");
            }
        }

    </script>

</body>

</html>